<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Alpha Engineer Portfolio Manager</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        
        h2 {
            color: #34495e;
            margin-top: 30px;
            margin-bottom: 15px;
        }
        
        .input-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .config-section {
            background-color: #e8f4f8;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 2px solid #3498db;
        }
        
        .info-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .input-row {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        
        label {
            display: inline-block;
            width: 200px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        input[type="number"], input[type="file"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
        }
        
        input[type="file"] {
            width: 300px;
        }
        
        .computed-value {
            display: inline-block;
            padding: 8px 12px;
            background-color: #e8f4f8;
            border: 1px solid #3498db;
            border-radius: 4px;
            font-weight: bold;
            color: #2c3e50;
            min-width: 150px;
        }
        
        .portfolio-table, .available-stocks-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .portfolio-table th, .available-stocks-table th {
            background-color: #34495e;
            color: white;
            padding: 10px;
            text-align: left;
            font-size: 12px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .available-stocks-table th {
            background-color: #27ae60;
        }
        
        .portfolio-table td, .available-stocks-table td {
            padding: 8px;
            border-bottom: 1px solid #ddd;
            font-size: 12px;
        }
        
        .portfolio-table tr:hover, .available-stocks-table tr:hover {
            background-color: #f5f5f5;
        }
        
        .ticker-input {
            width: 100px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            text-transform: uppercase;
        }
        
        .sell-signal {
            background-color: #e74c3c;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-weight: bold;
            text-align: center;
        }
        
        .hold-signal {
            background-color: #27ae60;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-weight: bold;
            text-align: center;
        }
        
        .not-found {
            color: #e74c3c;
            font-style: italic;
        }
        
        .button {
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .button:hover {
            background-color: #2980b9;
        }
        
        .export-button {
            background-color: #27ae60;
        }
        
        .export-button:hover {
            background-color: #229954;
        }
        
        .import-button {
            background-color: #8e44ad;
        }
        
        .import-button:hover {
            background-color: #7d3c98;
        }
        
        .random-button {
            background-color: #f39c12;
        }
        
        .random-button:hover {
            background-color: #e67e22;
        }
        
        .clear-button {
            background-color: #95a5a6;
        }
        
        .clear-button:hover {
            background-color: #7f8c8d;
        }
        
        .instructions {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .instructions h3 {
            margin-top: 0;
            color: #856404;
        }
        
        .instructions ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .status-message {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }
        
        .status-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .status-error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .table-container {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .section-label {
            color: #666;
            font-size: 0.9em;
            font-weight: normal;
            margin-left: 10px;
        }
        
        .summary-row {
            background-color: #f8f9fa;
            font-weight: bold;
            position: sticky;
            bottom: 0;
        }
        
        .selected-stock {
            background-color: #fff3cd !important;
            font-weight: bold;
        }
        
        .rank-99 {
            background-color: #e8f5e9;
        }
        
        .rank-98 {
            background-color: #f3e5f5;
        }
        
        .rank-97 {
            background-color: #e3f2fd;
        }
        
        .rank-96 {
            background-color: #fff3e0;
        }
        
        .rank-95 {
            background-color: #fce4ec;
        }
        
        .available-stocks-section {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 3px solid #3498db;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>The Alpha Engineer Portfolio Manager</h1>
        <div style="margin-top: -20px; margin-bottom: 20px; padding: 10px; background-color: #e8f4f8; border-radius: 5px; border-left: 4px solid #3498db;">
            <div style="margin-bottom: 5px;">
                <strong>Version 1.1</strong> | Released October 4, 2025 | 
                <a href="https://www.thealphaengineer.com/p/portfolio-manager-tool-v1-1" target="_blank" style="color: #3498db; text-decoration: none; font-weight: bold;">
                    ‚ú® What's New in v1.1
                </a>
            </div>
            <div style="font-size: 0.9em; color: #666;">
                Version 1.0 | Released August 22, 2025 | 
                <a href="https://www.thealphaengineer.com/p/portfolio-manager-tool" target="_blank" style="color: #3498db; text-decoration: none;">
                    v1.0 Explained
                </a>
            </div>
        </div>
        
        <div class="instructions">
            <h3>üìã How to Use This Tool</h3>
            <p><em>Core functionality remains unchanged from v1.0. New v1.1 features are optional enhancements (bold).</em></p>
            <ul>
                <li>Upload the latest Alpha Engineer stock ranking spreadsheet (Excel format)</li>
                <li>First time use: set your minimum rank threshold for SELL signals</li>
                <li>First time use: enter your current stock tickers in the portfolio table</li>
                <li>The tool will automatically show SELL signals for stocks below your minimum rank</li>
                <li>Review the Ranking spreadsheet or the <strong>"Available Top Stocks" section below for potential replacements</strong></li>
                <li><strong>Optional: Click "Remove" on any stocks you can't or don't want to buy</strong></li>
                <li><strong>Optional: Manually select stocks by clicking "Select" buttons OR use "Random Selection" for automatic picks</strong></li>
                <li>Execute your trades: sell the stocks marked SELL and buy your chosen replacements</li>
                <li>Optional: use the position sizing guide to determine minimum and maximum buy size</li>
                <li><strong>Important:</strong> Manually update your portfolio holdings by replacing sold tickers with bought tickers</li>
                <li>Export your portfolio to save it <strong>(including audit trail)</strong></li>
                <li>Import your portfolio next time to repeat the process</li>
            </ul>
        </div>
        
        <div id="statusMessage" class="status-message"></div>
        
        <div class="input-section">
            <h2>Configuration</h2>
            
            <div class="config-section">
                <div class="input-row">
                    <label for="stockDataFile">Stock Data Spreadsheet:</label>
                    <input type="file" id="stockDataFile" accept=".xlsx,.xls" />
                    <span class="section-label">(Required: Upload weekly ranking file)</span>
                </div>
                
                <div class="input-row">
                    <label for="minimumRank">Minimum Rank:</label>
                    <input type="number" id="minimumRank" value="90" min="1" max="99" />
                    <span class="section-label">(Required: Sell signal below this rank)</span>
                </div>
            </div>
            
            <h2>Position Sizing Guide</h2>
            <div class="info-section">
                <div class="input-row">
                    <label for="portfolioSize">Portfolio Size:</label>
                    <input type="number" id="portfolioSize" value="20" min="1" max="100" />
                    <span class="section-label">(Target number of stocks)</span>
                </div>
                
                <div class="input-row">
                    <label for="portfolioValue">Portfolio Value:</label>
                    <input type="number" id="portfolioValue" value="100000" min="0" step="1000" />
                    <span class="section-label">(Total value in your currency)</span>
                </div>
                
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd;">
                    <div class="input-row">
                        <label>Min Buy Size:</label>
                        <span class="computed-value" id="minBuySize">0</span>
                        <span class="section-label">(0.5 √ó average position)</span>
                    </div>
                    
                    <div class="input-row">
                        <label>Max Buy Size:</label>
                        <span class="computed-value" id="maxBuySize">0</span>
                        <span class="section-label">(1.5 √ó average position)</span>
                    </div>
                </div>
            </div>
        </div>
        
        <h2>Portfolio Holdings</h2>
        <div style="margin-bottom: 10px;">
            <button class="button import-button" onclick="document.getElementById('importFile').click()">üìÇ Import Portfolio</button>
            <button class="button export-button" onclick="exportToExcel()">üíæ Export Portfolio</button>
            <input type="file" id="importFile" accept=".xlsx" style="display: none;" onchange="importFromExcel(event)" />
            <button class="button clear-button" onclick="clearAllTickers()">üóëÔ∏è Clear All</button>
        </div>
        
        <div class="table-container">
            <table class="portfolio-table" id="portfolioTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Ticker</th>
                        <th>Name</th>
                        <th>Sector</th>
                        <th>Country</th>
                        <th>Mkt Cap</th>
                        <th>Current Rank</th>
                        <th>Previous Rank</th>
                        <th>Liquid</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="portfolioBody">
                    <!-- Dynamic content will be inserted here -->
                </tbody>
            </table>
        </div>
        
        <div style="margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
            <strong>Summary:</strong>
            <span id="holdingCount">0</span> holdings |
            <span id="sellCount" style="color: #e74c3c;">0</span> SELL signals |
            <span id="holdCount" style="color: #27ae60;">0</span> HOLD signals
        </div>
        
        <!-- New Section: Available Top Stocks -->
        <div class="available-stocks-section">
            <h2>Available Top Stocks</h2>
            <div style="margin-bottom: 10px;">
                <button class="button random-button" onclick="randomSelection()">üé≤ Random Selection</button>
                <button class="button" onclick="clearSelection()">‚úñ Clear Selection</button>
                <button class="button" style="background-color: #95a5a6;" onclick="clearAllRemovedStocks()">‚Ü∫ Restore All Removed</button>
                <span style="margin-left: 20px; font-size: 14px;">
                    <strong>Available:</strong> 
                    <span id="availableCount">0</span> stocks | 
                    <span id="selectedCount" style="color: #f39c12;">0</span> selected |
                    <span id="removedCount" style="color: #e74c3c;">0</span> removed
                </span>
            </div>
            
            <div class="table-container" style="max-height: 400px;">
                <table class="available-stocks-table" id="availableStocksTable">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Ticker</th>
                            <th>Name</th>
                            <th>Sector</th>
                            <th>Country</th>
                            <th>Mkt Cap</th>
                            <th>Current Rank</th>
                            <th>Previous Rank</th>
                            <th>Selection</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="availableStocksBody">
                        <!-- Dynamic content will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        let stockData = {};
        let portfolioTickers = new Array(100).fill('');
        let availableStocks = [];
        let selectedStocks = new Set();
        let removedStocks = new Set(); // Track removed stock tickers
        
        // Initialize the portfolio table with 100 rows
        function initializePortfolio() {
            const tbody = document.getElementById('portfolioBody');
            tbody.innerHTML = '';
            
            for (let i = 1; i <= 100; i++) {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${i}</td>
                    <td><input type="text" class="ticker-input" id="ticker-${i}" value="${portfolioTickers[i-1] || ''}" onchange="updateStockData(${i})" placeholder="Enter ticker" /></td>
                    <td id="name-${i}">-</td>
                    <td id="sector-${i}">-</td>
                    <td id="country-${i}">-</td>
                    <td id="mktcap-${i}">-</td>
                    <td id="rank-${i}">-</td>
                    <td id="prevrank-${i}">-</td>
                    <td id="liquid-${i}">-</td>
                    <td id="action-${i}">-</td>
                `;
            }
            
            // Refresh data for any existing tickers
            refreshData();
        }
        
        // Update computed values
        function updateComputedValues() {
            const portfolioSize = parseInt(document.getElementById('portfolioSize').value) || 20;
            const portfolioValue = parseFloat(document.getElementById('portfolioValue').value) || 100000;
            
            const avgPosition = portfolioValue / portfolioSize;
            const minBuy = Math.round(avgPosition * 0.5);
            const maxBuy = Math.round(avgPosition * 1.5);
            
            document.getElementById('minBuySize').textContent = minBuy;
            document.getElementById('maxBuySize').textContent = maxBuy;
        }
        
        // Format market cap
        function formatMarketCap(value) {
            if (!value || value === '-') return '-';
            const num = parseFloat(value);
            if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'B';
            } else {
                return num.toFixed(0) + 'M';
            }
        }
        
        // Handle stock data file upload
        document.getElementById('stockDataFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    // Build stock data lookup
                    stockData = {};
                    stockCount = {};
                    jsonData.forEach(row => {
                        if (row.Ticker) {
                            // Handle different ticker formats
                            const ticker = row.Ticker.toString().toUpperCase();
                            stockData[ticker] = row;
                            stockCount[ticker] = row;
                            
                            // Also store without exchange suffix for easier lookup
                            const simpleTicker = ticker.split(':')[0];
                            if (simpleTicker !== ticker) {
                                stockData[simpleTicker] = row;
                            }
                        }
                    });
                    
                    showStatus('Stock data loaded successfully! ' + Object.keys(stockCount).length + ' stocks available.', 'success');
                    removedStocks.clear(); // Clear removed stocks when loading new data
                    selectedStocks.clear(); // Clear selections when loading new data
                    refreshData();
                    updateAvailableStocks();
                } catch (error) {
                    showStatus('Error loading file: ' + error.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        });
        
        // Update stock data for a specific row
        function updateStockData(rowNum) {
            const tickerInput = document.getElementById(`ticker-${rowNum}`);
            const ticker = tickerInput.value.toUpperCase();
            
            // Store in our array
            portfolioTickers[rowNum - 1] = ticker;
            
            if (!ticker) {
                clearRow(rowNum);
                updateSummary();
                // Update available stocks only if not part of a bulk refresh
                if (!window.isRefreshing) {
                    updateAvailableStocks();
                }
                return;
            }
            
            const stock = stockData[ticker];
            const minimumRank = parseInt(document.getElementById('minimumRank').value);
            
            if (stock) {
                document.getElementById(`name-${rowNum}`).textContent = stock.Name || '-';
                document.getElementById(`sector-${rowNum}`).textContent = stock.Sector || '-';
                document.getElementById(`country-${rowNum}`).textContent = stock['Country ISO Code'] || '-';
                document.getElementById(`mktcap-${rowNum}`).textContent = formatMarketCap(stock['Mkt Cap (USD)']);
                document.getElementById(`rank-${rowNum}`).textContent = stock['Current Rank'] || '-';
                document.getElementById(`prevrank-${rowNum}`).textContent = stock['Previous Rank'] || '-';
                document.getElementById(`liquid-${rowNum}`).textContent = stock.Liquid || '-';
                
                // Determine action
                const currentRank = parseInt(stock['Current Rank']);
                const actionCell = document.getElementById(`action-${rowNum}`);
                
                if (currentRank < minimumRank) {
                    actionCell.innerHTML = '<div class="sell-signal">SELL</div>';
                } else {
                    actionCell.innerHTML = '<div class="hold-signal">HOLD</div>';
                }
            } else {
                document.getElementById(`name-${rowNum}`).innerHTML = '<span class="not-found">Not found in data - NO RANK</span>';
                document.getElementById(`sector-${rowNum}`).textContent = '-';
                document.getElementById(`country-${rowNum}`).textContent = '-';
                document.getElementById(`mktcap-${rowNum}`).textContent = '-';
                document.getElementById(`rank-${rowNum}`).textContent = '-';
                document.getElementById(`prevrank-${rowNum}`).textContent = '-';
                document.getElementById(`liquid-${rowNum}`).textContent = '-';
                document.getElementById(`action-${rowNum}`).textContent = '-';
                
                const actionCell = document.getElementById(`action-${rowNum}`);
                actionCell.innerHTML = '<div class="sell-signal">SELL</div>';
            }
            
            updateSummary();
            // Update available stocks only if not part of a bulk refresh
            if (!window.isRefreshing) {
                updateAvailableStocks();
            }
        }
        
        // Update available stocks list
        function updateAvailableStocks() {
            // Save currently selected tickers before rebuilding the array
            const selectedTickers = new Set();
            selectedStocks.forEach(index => {
                if (availableStocks[index]) {
                    selectedTickers.add(availableStocks[index].ticker);
                }
            });
            
            availableStocks = [];
            
            // Get portfolio tickers for exclusion - get them directly from the inputs
            const portfolioTickerSet = new Set();
            for (let i = 1; i <= 100; i++) {
                const tickerInput = document.getElementById(`ticker-${i}`);
                if (tickerInput && tickerInput.value) {
                    const ticker = tickerInput.value.toUpperCase().trim();
                    if (ticker) {
                        portfolioTickerSet.add(ticker);
                        // Also add the simplified version (without exchange)
                        const simpleTicker = ticker.split(':')[0];
                        portfolioTickerSet.add(simpleTicker);
                        
                        // Remove from selected if now in portfolio
                        selectedTickers.delete(ticker);
                        selectedTickers.delete(simpleTicker);
                    }
                }
            }
            
            // Filter stocks with rank 95-99, liquid = yes, not in portfolio
            Object.entries(stockData).forEach(([ticker, stock]) => {
                const currentRank = parseInt(stock['Current Rank']);
                const isLiquid = stock.Liquid && stock.Liquid.toString().toLowerCase() === 'yes';
                
                // Check both the full ticker and simplified ticker
                const simpleTicker = ticker.split(':')[0];
                const isInPortfolio = portfolioTickerSet.has(ticker) || portfolioTickerSet.has(simpleTicker);
                
                // Only include the main ticker (not the simplified version)
                if ((currentRank >= 95 && currentRank <= 99) && 
                    isLiquid && 
                    !isInPortfolio &&
                    ticker === stock.Ticker) { // Ensure we only use the original ticker
                    availableStocks.push({
                        ticker: ticker,
                        ...stock
                    });
                }
            });
            
            // Sort by rank (descending) then alphabetically by ticker
            availableStocks.sort((a, b) => {
                const rankDiff = parseInt(b['Current Rank']) - parseInt(a['Current Rank']);
                if (rankDiff !== 0) return rankDiff;
                return a.ticker.localeCompare(b.ticker);
            });
            
            // Rebuild selectedStocks with new indices
            selectedStocks.clear();
            availableStocks.forEach((stock, index) => {
                if (selectedTickers.has(stock.ticker)) {
                    selectedStocks.add(index);
                }
            });
            
            // Display available stocks
            displayAvailableStocks();
            updateAvailableSummary();
        }
        
        // Display available stocks in the table
        function displayAvailableStocks() {
            const tbody = document.getElementById('availableStocksBody');
            tbody.innerHTML = '';
            
            availableStocks.forEach((stock, index) => {
                const row = tbody.insertRow();
                const rank = parseInt(stock['Current Rank']);
                const isRemoved = removedStocks.has(stock.ticker);
                const isSelected = selectedStocks.has(index);
                
                let rankClass = '';
                if (rank === 99) rankClass = 'rank-99';
                else if (rank === 98) rankClass = 'rank-98';
                else if (rank === 97) rankClass = 'rank-97';
                else if (rank === 96) rankClass = 'rank-96';
                else if (rank === 95) rankClass = 'rank-95';
                
                row.className = rankClass;
                if (isSelected && !isRemoved) {
                    row.classList.add('selected-stock');
                }
                row.id = `available-row-${index}`;
                
                if (isRemoved) {
                    row.style.opacity = '0.4';
                    row.style.textDecoration = 'line-through';
                }
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${stock.ticker}</td>
                    <td>${stock.Name || '-'}</td>
                    <td>${stock.Sector || '-'}</td>
                    <td>${stock['Country ISO Code'] || '-'}</td>
                    <td>${formatMarketCap(stock['Mkt Cap (USD)'])}</td>
                    <td>${stock['Current Rank'] || '-'}</td>
                    <td>${stock['Previous Rank'] || '-'}</td>
                    <td>
                        ${isRemoved 
                            ? '<span style="color: #999;">-</span>'
                            : isSelected
                                ? `<button class="button" style="background-color: #f39c12; padding: 5px 10px; font-size: 11px;" onclick="toggleSelection(${index})">‚úì Selected</button>`
                                : `<button class="button" style="background-color: #95a5a6; padding: 5px 10px; font-size: 11px;" onclick="toggleSelection(${index})">Select</button>`
                        }
                    </td>
                    <td>
                        ${isRemoved 
                            ? `<button class="button" style="background-color: #27ae60; padding: 5px 10px; font-size: 11px;" onclick="restoreStock('${stock.ticker}')">‚úì Restore</button>`
                            : `<button class="button" style="background-color: #e74c3c; padding: 5px 10px; font-size: 11px;" onclick="removeStock('${stock.ticker}')">‚úñ Remove</button>`
                        }
                    </td>
                `;
            });
        }
        
        // Toggle selection of a stock (manual selection)
        function toggleSelection(index) {
            const stock = availableStocks[index];
            if (!stock || removedStocks.has(stock.ticker)) return;
            
            if (selectedStocks.has(index)) {
                selectedStocks.delete(index);
            } else {
                selectedStocks.add(index);
            }
            
            // Update display for this specific row
            const row = document.getElementById(`available-row-${index}`);
            if (row) {
                if (selectedStocks.has(index)) {
                    row.classList.add('selected-stock');
                    row.cells[8].innerHTML = `<button class="button" style="background-color: #f39c12; padding: 5px 10px; font-size: 11px;" onclick="toggleSelection(${index})">‚úì Selected</button>`;
                } else {
                    row.classList.remove('selected-stock');
                    row.cells[8].innerHTML = `<button class="button" style="background-color: #95a5a6; padding: 5px 10px; font-size: 11px;" onclick="toggleSelection(${index})">Select</button>`;
                }
            }
            
            updateAvailableSummary();
        }
        
        // Remove a stock from consideration
        function removeStock(ticker) {
            removedStocks.add(ticker);
            // Clear selection for this stock if it was selected
            const stockIndex = availableStocks.findIndex(s => s.ticker === ticker);
            if (stockIndex !== -1 && selectedStocks.has(stockIndex)) {
                selectedStocks.delete(stockIndex);
            }
            displayAvailableStocks();
            updateAvailableSummary();
        }
        
        // Restore a removed stock
        function restoreStock(ticker) {
            removedStocks.delete(ticker);
            displayAvailableStocks();
            updateAvailableSummary();
        }
        
        // Clear all removed stocks
        function clearAllRemovedStocks() {
            removedStocks.clear();
            displayAvailableStocks();
            updateAvailableSummary();
            showStatus('All removed stocks have been restored', 'success');
        }
        
        // Random selection of stocks
        function randomSelection() {
            // Clear all existing selections first
            clearSelection();
            
            // Count SELL signals
            let sellCount = 0;
            for (let i = 1; i <= 100; i++) {
                const actionCell = document.getElementById(`action-${i}`);
                if (actionCell && actionCell.textContent === 'SELL') {
                    sellCount++;
                }
            }
            
            if (sellCount === 0) {
                showStatus('No SELL signals to replace. No stocks selected.', 'error');
                return;
            }
            
            // Filter out removed stocks from available stocks
            const selectableStocks = availableStocks.filter(stock => !removedStocks.has(stock.ticker));
            
            if (selectableStocks.length === 0) {
                showStatus('No available stocks to select from (all are removed or excluded).', 'error');
                return;
            }
            
            // Group selectable stocks by rank
            const stocksByRank = {
                99: selectableStocks.filter(s => parseInt(s['Current Rank']) === 99),
                98: selectableStocks.filter(s => parseInt(s['Current Rank']) === 98),
                97: selectableStocks.filter(s => parseInt(s['Current Rank']) === 97),
                96: selectableStocks.filter(s => parseInt(s['Current Rank']) === 96),
                95: selectableStocks.filter(s => parseInt(s['Current Rank']) === 95)
            };
            
            // Select stocks with priority: 99 > 98 > 97 > 96 > 95
            let toSelect = sellCount;
            const ranks = [99, 98, 97, 96, 95];
            
            for (const rank of ranks) {
                if (toSelect === 0) break;
                
                const stocksAtRank = [...stocksByRank[rank]]; // Create copy for shuffling
                
                // Shuffle the stocks at this rank
                for (let i = stocksAtRank.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [stocksAtRank[i], stocksAtRank[j]] = [stocksAtRank[j], stocksAtRank[i]];
                }
                
                // Select up to toSelect stocks from this rank
                const selectFromRank = Math.min(toSelect, stocksAtRank.length);
                for (let i = 0; i < selectFromRank; i++) {
                    const stock = stocksAtRank[i];
                    const index = availableStocks.findIndex(s => s.ticker === stock.ticker);
                    selectedStocks.add(index);
                }
                
                toSelect -= selectFromRank;
            }
            
            // Refresh display to show selections
            displayAvailableStocks();
            updateAvailableSummary();
            
            if (toSelect > 0) {
                showStatus(`${selectedStocks.size} stocks randomly selected (${toSelect} fewer than requested due to removed/unavailable stocks).`, 'success');
            } else {
                showStatus(`${selectedStocks.size} stocks randomly selected for purchase.`, 'success');
            }
        }
        
        // Clear selection
        function clearSelection() {
            selectedStocks.clear();
            
            // Refresh the display to remove selection highlights
            displayAvailableStocks();
            updateAvailableSummary();
        }
        
        // Update available stocks summary
        function updateAvailableSummary() {
            const totalAvailable = availableStocks.length;
            const removedCount = Array.from(removedStocks).filter(ticker => 
                availableStocks.some(stock => stock.ticker === ticker)
            ).length;
            const effectiveAvailable = availableStocks.filter(stock => !removedStocks.has(stock.ticker)).length;
            
            document.getElementById('availableCount').textContent = effectiveAvailable;
            document.getElementById('selectedCount').textContent = selectedStocks.size;
            document.getElementById('removedCount').textContent = removedCount;
        }
        
        // Clear a row
        function clearRow(rowNum) {
            document.getElementById(`name-${rowNum}`).textContent = '-';
            document.getElementById(`sector-${rowNum}`).textContent = '-';
            document.getElementById(`country-${rowNum}`).textContent = '-';
            document.getElementById(`mktcap-${rowNum}`).textContent = '-';
            document.getElementById(`rank-${rowNum}`).textContent = '-';
            document.getElementById(`prevrank-${rowNum}`).textContent = '-';
            document.getElementById(`liquid-${rowNum}`).textContent = '-';
            document.getElementById(`action-${rowNum}`).textContent = '-';
        }
        
        // Clear all tickers
        function clearAllTickers() {
            if (confirm('Are you sure you want to clear all tickers?')) {
                window.isRefreshing = true;
                portfolioTickers = new Array(100).fill('');
                for (let i = 1; i <= 100; i++) {
                    document.getElementById(`ticker-${i}`).value = '';
                    clearRow(i);
                }
                window.isRefreshing = false;
                updateSummary();
                updateAvailableStocks();
                showStatus('All tickers cleared', 'success');
            }
        }
        
        // Update summary
        function updateSummary() {
            let holdingCount = 0;
            let sellCount = 0;
            let holdCount = 0;
            
            for (let i = 1; i <= 100; i++) {
                const ticker = document.getElementById(`ticker-${i}`).value;
                if (ticker) {
                    holdingCount++;
                    const actionCell = document.getElementById(`action-${i}`);
                    const action = actionCell ? actionCell.textContent : '';
                    if (action === 'SELL') sellCount++;
                    else if (action === 'HOLD') holdCount++;
                }
            }
            
            document.getElementById('holdingCount').textContent = holdingCount;
            document.getElementById('sellCount').textContent = sellCount;
            document.getElementById('holdCount').textContent = holdCount;
        }
        
        // Refresh all data
        function refreshData() {
            window.isRefreshing = true;
            for (let i = 1; i <= 100; i++) {
                if (document.getElementById(`ticker-${i}`).value) {
                    updateStockData(i);
                }
            }
            window.isRefreshing = false;
            // Always update available stocks after refreshing
            updateAvailableStocks();
        }
        
        // Import from Excel
        function importFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    // Clear existing tickers
                    portfolioTickers = new Array(100).fill('');
                    
                    // Look for configuration values and tickers
                    let tickerStartRow = -1;
                    let portfolioSize = 20;
                    let portfolioValue = 100000;
                    let minimumRank = 50;
                    
                    for (let i = 0; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (row[0] === 'Portfolio Target Size' && row[1]) {
                            portfolioSize = parseFloat(row[1]);
                        } else if (row[0] === 'Portfolio Value' && row[1]) {
                            portfolioValue = parseFloat(row[1]);
                        } else if (row[0] === 'Minimum Rank' && row[1]) {
                            minimumRank = parseFloat(row[1]);
                        } else if (row[0] === '#' || row[0] === 1) {
                            tickerStartRow = i + 1;
                            break;
                        }
                    }
                    
                    // Import configuration
                    document.getElementById('portfolioSize').value = portfolioSize;
                    document.getElementById('portfolioValue').value = portfolioValue;
                    document.getElementById('minimumRank').value = minimumRank;
                    updateComputedValues();
                    
                    // Import tickers
                    if (tickerStartRow > 0) {
                        let importedCount = 0;
                        for (let i = tickerStartRow; i < jsonData.length && importedCount < 100; i++) {
                            const row = jsonData[i];
                            
                            // Stop if we hit the "Selected for Purchase" section or empty rows
                            if (!row[0] && !row[1]) break; // Empty row
                            if (row[0] === '' && row[1] === 'Selected for Purchase') break;
                            if (row[1] === 'Selected for Purchase') break;
                            if (row[0] === 'Selected for Purchase') break;
                            
                            // Only import if there's a valid ticker in column B
                            if (row[1] && row[1] !== 'Ticker' && row[1] !== 'TICKER') { // Skip header rows
                                portfolioTickers[importedCount] = row[1].toString().toUpperCase();
                                importedCount++;
                            }
                        }
                    }
                    
                    // Refresh the display
                    initializePortfolio();
                    updateAvailableStocks(); // Update available stocks after import
                    showStatus(`Portfolio imported successfully! ${portfolioTickers.filter(t => t).length} tickers loaded.`, 'success');
                    
                } catch (error) {
                    showStatus('Error importing file: ' + error.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
            
            // Clear the file input so the same file can be selected again
            event.target.value = '';
        }
        
        // Export to Excel
        function exportToExcel() {
            const portfolioSize = parseInt(document.getElementById('portfolioSize').value);
            const portfolioValue = parseFloat(document.getElementById('portfolioValue').value);
            const minimumRank = parseInt(document.getElementById('minimumRank').value);
            
            // Create configuration data
            const configData = [
                ['The Alpha Engineer Portfolio Manager'],
                ['Export Date', new Date().toLocaleDateString()],
                [''],
                ['Configuration'],
                ['Portfolio Target Size', portfolioSize],
                ['Portfolio Value', portfolioValue],
                ['Minimum Rank', minimumRank],
                ['Min Buy Size', portfolioValue / portfolioSize * 0.5],
                ['Max Buy Size', portfolioValue / portfolioSize * 1.5],
                [''],
                ['Portfolio Holdings']
            ];
            
            // Create portfolio data
            const portfolioData = [
                ['#', 'Ticker', 'Name', 'Sector', 'Country', 'Mkt Cap', 'Current Rank', 'Previous Rank', 'Liquid', 'Action']
            ];
            
            // Add all tickers (including empty ones for import compatibility)
            for (let i = 1; i <= 100; i++) {
                const ticker = document.getElementById(`ticker-${i}`).value;
                if (ticker) {
                    portfolioData.push([
                        i,
                        ticker,
                        document.getElementById(`name-${i}`).textContent,
                        document.getElementById(`sector-${i}`).textContent,
                        document.getElementById(`country-${i}`).textContent,
                        document.getElementById(`mktcap-${i}`).textContent,
                        document.getElementById(`rank-${i}`).textContent,
                        document.getElementById(`prevrank-${i}`).textContent,
                        document.getElementById(`liquid-${i}`).textContent,
                        document.getElementById(`action-${i}`).textContent
                    ]);
                }
            }
            
            // Add summary of actions for reference
            const sellStocks = [];
            for (let i = 1; i <= 100; i++) {
                const ticker = document.getElementById(`ticker-${i}`).value;
                if (ticker) {
                    const action = document.getElementById(`action-${i}`).textContent;
                    if (action === 'SELL') {
                        sellStocks.push(ticker);
                    }
                }
            }
            
            if (sellStocks.length > 0) {
                portfolioData.push(['']);
                portfolioData.push(['']);
                portfolioData.push(['--- ACTION SUMMARY (REFERENCE ONLY) ---']);
                portfolioData.push(['Stocks to SELL', sellStocks.join(', ')]);
                portfolioData.push(['Number of SELL signals', sellStocks.length]);
                if (selectedStocks.size > 0) {
                    portfolioData.push(['Number of stocks selected for purchase', selectedStocks.size]);
                }
                portfolioData.push(['--- END ACTION SUMMARY ---']);
            }
            
            // Add selected stocks section if any are selected
            if (selectedStocks.size > 0) {
                portfolioData.push(['']);
                portfolioData.push(['']);
                portfolioData.push(['--- REFERENCE ONLY - DO NOT IMPORT ---']);
                portfolioData.push(['Selected for Purchase (from last week)']);
                portfolioData.push(['#', 'Ticker', 'Name', 'Sector', 'Country', 'Mkt Cap', 'Current Rank']);
                
                let selectedIndex = 1;
                selectedStocks.forEach(index => {
                    const stock = availableStocks[index];
                    if (stock) {
                        portfolioData.push([
                            selectedIndex++,
                            stock.ticker,
                            stock.Name || '-',
                            stock.Sector || '-',
                            stock['Country ISO Code'] || '-',
                            formatMarketCap(stock['Mkt Cap (USD)']),
                            stock['Current Rank'] || '-'
                        ]);
                    }
                });
                portfolioData.push(['--- END OF REFERENCE SECTION ---']);
            }
            
            // Combine all data
            const exportData = [...configData, ...portfolioData];
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(exportData);
            
            // Add column widths
            ws['!cols'] = [
                { wch: 5 },   // #
                { wch: 12 },  // Ticker
                { wch: 30 },  // Name
                { wch: 20 },  // Sector
                { wch: 10 },  // Country
                { wch: 15 },  // Mkt Cap
                { wch: 12 },  // Current Rank
                { wch: 12 },  // Previous Rank
                { wch: 8 },   // Liquid
                { wch: 10 }   // Action
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'Portfolio');
            
            // Generate filename with date
            const today = new Date().toISOString().split('T')[0];
            const filename = `AlphaEngineer_Portfolio_${today}.xlsx`;
            
            // Export file
            XLSX.writeFile(wb, filename);
            showStatus('Portfolio exported successfully!', 'success');
        }
        
        // Show status message
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = 'status-message status-' + type;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }
        
        // Event listeners for position sizing guide
        document.getElementById('portfolioSize').addEventListener('change', updateComputedValues);
        document.getElementById('portfolioValue').addEventListener('change', updateComputedValues);
        document.getElementById('minimumRank').addEventListener('change', refreshData);
        
        // Initialize on load
        initializePortfolio();
        updateComputedValues();
    </script>
</body>
</html>
